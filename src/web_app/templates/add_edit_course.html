{% extends "base.html" %}

{% block title %}{% if course %}Редактировать курс{% else %}Добавить новый курс{% endif %}{% endblock %}

{% block content %}
<h1 class="mb-4">{% if course %}Редактировать курс{% else %}Добавить новый курс{% endif %}</h1>

<h3>Тема: {{ topic[1] }}</h3>

{% if error %}
<div class="alert alert-danger" role="alert">
    {{ error }}
</div>
{% endif %}

<form method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="name" class="form-label">Название курса</label>
        <input type="text" class="form-control" id="name" name="name" value="{% if course %}{{ course[1] }}{% endif %}" required>
    </div>
    
    <div class="mb-3">
        <label for="description" class="form-label">Описание курса</label>
        <textarea class="form-control" id="description" name="description" rows="3">{% if course %}{{ course[2] }}{% endif %}</textarea>
        <small class="form-text text-muted">Длина описания: <span id="desc_counter">0</span>/1024 символов</small>
    </div>
    
    <div class="mb-3">
        <label for="price" class="form-label">Цена курса</label>
        <input type="number" class="form-control" id="price" name="price" step="0.01" value="{% if course %}{{ course[3] }}{% endif %}" required>
    </div>
    
    <div class="mb-3">
        <label for="payment_link" class="form-label">Ссылка для оплаты</label>
        <input type="url" class="form-control" id="payment_link" name="payment_link" value="{% if course %}{{ course[5] }}{% endif %}">
    </div>
    
    {% if course and course.image_path %}
    <div class="mb-3">
        <label for="current-image" class="form-label">Текущее изображение</label><br>
        <img src="{{ url_for('static', path='img/courses/' + course.image_path) }}" alt="Текущее изображение" style="max-width: 200px; max-height: 200px;" loading="lazy">
    </div>
    {% endif %}
    <div class="mb-3">
        <label for="image" class="form-label">Изображение курса</label>
        <input type="file" name="image" class="form-control-file" id="image">
    </div>
    
    <button type="submit" class="btn btn-primary">{% if course %}Сохранить изменения{% else %}Добавить курс{% endif %}</button>
    <a href="/topics/{{ topic[0] }}/courses" class="btn btn-secondary">Отмена</a>
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Подсчет символов для описания курса
        const descriptionInput = document.getElementById('description');
        const counterElement = document.getElementById('desc_counter');
        
        if (descriptionInput && counterElement) {
            // Обновляем счетчик при загрузке страницы
            updateCounter(descriptionInput, counterElement);
            
            // Обновляем счетчик при каждом вводе символа
            descriptionInput.addEventListener('input', function() {
                updateCounter(descriptionInput, counterElement);
            });
        }

        // Функция для обновления счетчика
        function updateCounter(input, counterEl) {
            const currentLength = input.value.length;
            counterEl.textContent = currentLength;
        }

        const imageInput = document.getElementById('image');
        const formImageInput = document.getElementById('formFile'); // Assuming this is the actual file input for the course image

        if (imageInput) {
            imageInput.addEventListener('change', function(event) {
                handleImagePreview(event, imageInput);
            });
        } else if (formImageInput) {
            formImageInput.addEventListener('change', function(event) {
                handleImagePreview(event, formImageInput);
            });
        }

        function handleImagePreview(event, inputElement) {
            const [file] = inputElement.files;
            const existingPreviewContainer = document.getElementById('image-preview-container');

            // If a file is selected
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let previewContainer = existingPreviewContainer;
                    if (!previewContainer) {
                        previewContainer = document.createElement('div');
                        previewContainer.id = 'image-preview-container';
                        previewContainer.classList.add('mb-3');
                        
                        const label = document.createElement('label');
                        label.classList.add('form-label');
                        label.textContent = 'Предпросмотр нового изображения';
                        previewContainer.appendChild(label);
                        previewContainer.appendChild(document.createElement('br'));
                        
                        // Insert the preview container right after the current image display or the file input
                        const currentImageDiv = document.querySelector('div.mb-3 img[alt="Текущее изображение"]');
                        if (currentImageDiv) {
                            currentImageDiv.parentElement.insertAdjacentElement('afterend', previewContainer);
                        } else {
                            inputElement.insertAdjacentElement('afterend', previewContainer);
                        }
                    }

                    // Clear existing preview image if any
                    const existingPreviewImage = previewContainer.querySelector('img');
                    if (existingPreviewImage) {
                        existingPreviewImage.remove();
                    }

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                // If no file is selected, remove the preview container if it exists
                if (existingPreviewContainer) {
                    existingPreviewContainer.remove();
                }
            }
        }
    });
</script>
{% endblock %}