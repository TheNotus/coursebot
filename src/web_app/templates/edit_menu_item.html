{% extends "base.html" %}

{% block title %}Редактировать пункт меню{% endblock %}

{% block content %}
<h1 class="mb-4">Редактировать пункт меню</h1>

<form method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="key" class="form-label">Ключ (только для чтения)</label>
        <input type="text" class="form-control" id="key" name="key" value="{{ key }}" readonly>
    </div>
    
    <div class="mb-3">
        <label for="title" class="form-label">Заголовок</label>
        <input type="text" class="form-control" id="title" name="title" value="{{ title }}" required>
    </div>
    
    <div class="mb-3">
        <label for="content" class="form-label">Содержание</label>
        <textarea class="form-control" id="content" name="content" rows="5" required>{{ content }}</textarea>
        <small class="form-text text-muted">Длина содержания: <span id="content_counter">0</span>/1024 символов</small>
    </div>
    
    <div class="mb-3">
        <label for="image" class="form-label">Изображение</label>
        <input type="file" class="form-control" id="image" name="image" accept="image/*">
    </div>
    
    <!-- Новое поле для URL-ссылки -->
    <div class="mb-3">
        <label for="url_link" class="form-label">URL-сылка</label>
        <input type="text" class="form-control" id="url_link" name="url_link" value="{{ url_link or '' }}">
        <small class="form-text text-muted">Введите действительный URL-адрес (например, https://example.com)</small>
    </div>
    
    {% if image_path %}
    <div class="mb-3">
        <label class="form-label">Текущее изображение</label>
        <div>
            <img src="{{ url_for('static', path=image_path.replace('src/web_app/static/', '')) }}" alt="Текущее изображение" style="max-width: 200px; max-height: 200px;" loading="lazy">
        </div>
    </div>
    {% endif %}
    
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a href="/admin/menu_items" class="btn btn-secondary">Отмена</a>
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Подсчет символов для содержания пункта меню
        const contentInput = document.getElementById('content');
        const counterElement = document.getElementById('content_counter');
        
        if (contentInput && counterElement) {
            // Обновляем счетчик при загрузке страницы
            updateCounter(contentInput, counterElement);
            
            // Обновляем счетчик при каждом вводе символа
            contentInput.addEventListener('input', function() {
                updateCounter(contentInput, counterElement);
            });
        }

        // Функция для обновления счетчика
        function updateCounter(input, counterEl) {
            const currentLength = input.value.length;
            counterEl.textContent = currentLength;
        }

        // Добавляем функциональность предпросмотра изображения
        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Проверяем, существует ли уже контейнер для предпросмотра
                    let previewContainer = document.getElementById('image-preview-container');
                    
                    if (!previewContainer) {
                        // Создаем контейнер для предпросмотра, если его нет
                        previewContainer = document.createElement('div');
                        previewContainer.id = 'image-preview-container';
                        previewContainer.className = 'mb-3';
                        
                        // Добавляем метку
                        const label = document.createElement('label');
                        label.className = 'form-label';
                        label.textContent = 'Предварительный просмотр';
                        previewContainer.appendChild(label);
                        
                        // Вставляем контейнер после поля ввода изображения
                        e.target.parentNode.parentNode.insertBefore(previewContainer, e.target.parentNode.nextSibling);
                    }
                    
                    // Очищаем предыдущий контент
                    previewContainer.innerHTML = '<label class="form-label">Предварительный просмотр</label>';
                    
                    // Создаем элемент изображения для предпросмотра
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Предварительный просмотр';
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    img.style.marginTop = '10px';
                    
                    previewContainer.appendChild(img);
                };
                
                reader.readAsDataURL(file);
            }
        });
    });
</script>
{% endblock %}